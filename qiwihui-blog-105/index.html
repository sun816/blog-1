<!DOCTYPE html><html lang><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Rust Actix-web 写一个 Todo 应用（一） · QIWIHUI</title><meta name="description" content="用 Rust Actix-web 写一个 Todo 应用（一） - qiwihui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/nella.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-8935595858652656",
enable_page_level_ads: true
});
</script><link rel="search" type="application/opensearchdescription+xml" href="https://qiwihui.com/atom.xml" title="QIWIHUI"><meta property="og:site_name" content="QIWIHUI"><meta property="og:url" content="https://qiwihui.com/qiwihui-blog-105/index.html"><meta property="og:title" content="用 Rust Actix-web 写一个 Todo 应用（一）"><meta property="og:description" content="用 Rust Actix-web 写一个 Todo 应用（一）"><meta property="og:type" content="article"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><!--li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") SEARCH--></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">用 Rust Actix-web 写一个 Todo 应用（一）</h1><div class="post-info">Oct 20, 2020<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/技术/" class="post-category">#技术</a><span>10 min. read</span></div><div class="post-content"><h2>Actix</h2>
<p>actix 是 Rust 生态中的 Actor 系统。actix-web 是在 actix actor 框架和 Tokio 异步 IO 系统之上构建的高级 Web 框架。</p>
<p>本篇博客实践使用 actix-web 实现一个简单的 todo 应用。基本要求：了解 rust 基本语法，了解一定的 sql 和 docker 知识。</p>
<a id="more"></a>
<h2>创建一个 Hello world 程序</h2>
<p>首先，新建一个 <code>todo-list</code> 项目，并在其中增加 <code>actix-web</code> 依赖，我们使用最新的 actix 3.0。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cargo new todo-list</span><br><span class="line">cd todo-list</span><br></pre></td></tr></table></figure>
<p><code>Cargo.toml</code>：</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[package]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">"todo-list"</span></span><br><span class="line"><span class="attr">version</span> = <span class="string">"0.1.0"</span></span><br><span class="line"><span class="attr">authors</span> = [<span class="string">"qiwihui &lt;qwh005007@gmail.com&gt;"</span>]</span><br><span class="line"><span class="attr">edition</span> = <span class="string">"2018"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">actix-web</span> = <span class="string">"3"</span></span><br></pre></td></tr></table></figure>
<p>在 <code>main.rs</code> 中，使用类似于 python flask 的语法，增加一个最简单的 service。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> actix_web::&#123;get, App, HttpServer, Responder&#125;;</span><br><span class="line"><span class="keyword">use</span> std::io::<span class="built_in">Result</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[get(<span class="meta-string">"/"</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>() -&gt; <span class="keyword">impl</span> Responder &#123;</span><br><span class="line">    <span class="comment">// String 实现了 Responder trait</span></span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">"Hello world!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[actix_web::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; <span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Starting server at http://127.0.0.1:8000"</span>);</span><br><span class="line">    HttpServer::new(|| App::new().service(hello))</span><br><span class="line">        .bind(<span class="string">"127.0.0.1:8000"</span>)?</span><br><span class="line">        .run()</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行并测试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cargo run</span><br></pre></td></tr></table></figure>
<p>在另一个终端中</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> curl 127.0.0.1:8000</span><br><span class="line">Hello world!</span><br></pre></td></tr></table></figure>
<h2>数据库设计</h2>
<p>项目中将使用 postgres 作为数据库存储，为了方便操作和管理，我们使用 docker-compose 进行管理。</p>
<p><code>docker-compose.yml</code></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:11-alpine</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">actix</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">actix</span></span><br><span class="line">      <span class="attr">POSTGRES_DB:</span> <span class="string">actix</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br></pre></td></tr></table></figure>
<p>创建数据库：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>然后，我们设计整体数据库表结构，并创建一些基础数据作为测试。表结构如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"> TodoList           TodoItem</span><br><span class="line">                   +---------+</span><br><span class="line">                   |  id     |</span><br><span class="line">+-------+          +---------+</span><br><span class="line">|  id   + &lt;-- FK --+ list_id |</span><br><span class="line">+-------+          +---------+</span><br><span class="line">| title |          | title   |</span><br><span class="line">+-------+          +---------+</span><br><span class="line">                   | checked |</span><br><span class="line">                   +---------+</span><br></pre></td></tr></table></figure>
<p>在 <code>database.sql</code> 中手动创建表结构并插入数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> todo_list;</span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> todo_item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> todo_list (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>,</span><br><span class="line">    title <span class="built_in">varchar</span>(<span class="number">150</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> todo_item (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>,</span><br><span class="line">    title <span class="built_in">varchar</span>(<span class="number">150</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    checked <span class="built_in">boolean</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">false</span>,</span><br><span class="line">    list_id <span class="built_in">integer</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">foreign</span> <span class="keyword">key</span> (list_id) <span class="keyword">references</span> todo_list(<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span></span><br><span class="line">    todo_list (title)</span><br><span class="line"><span class="keyword">values</span></span><br><span class="line">    (<span class="string">'List 1'</span>),</span><br><span class="line">    (<span class="string">'List 2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span></span><br><span class="line">    todo_item (title, list_id)</span><br><span class="line"><span class="keyword">values</span></span><br><span class="line">    (<span class="string">'item 1'</span>, <span class="number">1</span>),</span><br><span class="line">    (<span class="string">'item 2'</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>创建数据表并查看结果</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> psql -h 127.0.0.1 -p 5432 -U actix actix &lt; database.sql </span><br><span class="line">Password for user actix: </span><br><span class="line">NOTICE:  table "todo_list" does not exist, skipping</span><br><span class="line">DROP TABLE</span><br><span class="line">NOTICE:  table "todo_item" does not exist, skipping</span><br><span class="line">DROP TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">CREATE TABLE</span><br><span class="line">INSERT 0 2</span><br><span class="line">INSERT 0 2</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> psql -h 127.0.0.1 -p 5432 -U actix actix</span><br><span class="line">Password for user actix: </span><br><span class="line">psql (12.4, server 11.9)</span><br><span class="line">Type "help" for help.</span><br><span class="line"></span><br><span class="line">actix=# \d</span><br><span class="line">              List of relations</span><br><span class="line"> Schema |       Name       |   Type   | Owner </span><br><span class="line">--------+------------------+----------+-------</span><br><span class="line"> public | todo_item        | table    | actix</span><br><span class="line"> public | todo_item_id_seq | sequence | actix</span><br><span class="line"> public | todo_list        | table    | actix</span><br><span class="line"> public | todo_list_id_seq | sequence | actix</span><br><span class="line">(4 rows)</span><br><span class="line"></span><br><span class="line">actix=# select * from todo_list;</span><br><span class="line"> id | title  </span><br><span class="line">----+--------</span><br><span class="line">  1 | List 1</span><br><span class="line">  2 | List 2</span><br><span class="line">(2 rows)</span><br></pre></td></tr></table></figure>
<h2>获取 todo 列表</h2>
<p>首先，添加我们需要的库，其中 <code>serde</code> 用于序列化，<code>tokio-postgres</code> 是一直支持异步的 PostgreSQL 客户端，<code>deadpool-postgres</code> 用于连接池的管理。</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">actix-web</span> = <span class="string">"3"</span></span><br><span class="line"><span class="attr">serde</span>=<span class="string">"1.0.117"</span></span><br><span class="line"><span class="attr">deadpool-postgres</span> = <span class="string">"0.5.0"</span></span><br><span class="line"><span class="attr">tokio-postgres</span> = <span class="string">"0.5.1"</span></span><br></pre></td></tr></table></figure>
<p>增加 <code>models.rs</code> 用于管理数据模型，并支持序列化和反序列化。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TodoList</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TodoItem</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> checked: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> list_id: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加 <code>db.rs</code> 用于管理数据操作，例如 <code>get_todos</code> 从数据库中获取数据并序列化为 <code>TodoList</code> 的数组：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::models::&#123;TodoItem, TodoList&#125;;</span><br><span class="line"><span class="keyword">use</span> deadpool_postgres::Client;</span><br><span class="line"><span class="keyword">use</span> std::io::Error;</span><br><span class="line"><span class="keyword">use</span> tokio_postgres::Row;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将每条记录转为 TodoList</span></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">row_to_todo</span></span>(row: &amp;Row) -&gt; TodoList &#123;</span><br><span class="line">    <span class="keyword">let</span> id: <span class="built_in">i32</span> = row.get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">let</span> title: <span class="built_in">String</span> = row.get(<span class="number">1</span>);</span><br><span class="line">    TodoList &#123; id, title &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_todos</span></span>(client: &amp;Client) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;TodoList&gt;, Error&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> statement = client</span><br><span class="line">        .prepare(<span class="string">"select * from todo_list order by id desc"</span>)</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .unwrap();</span><br><span class="line">    <span class="keyword">let</span> todos = client</span><br><span class="line">        .query(&amp;statement, &amp;[])</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .expect(<span class="string">"Error getting todo lists"</span>)</span><br><span class="line">        .iter()</span><br><span class="line">        .map(|row| row_to_todo(row))</span><br><span class="line">        .collect::&lt;<span class="built_in">Vec</span>&lt;TodoList&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(todos)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>增加 <code>handlers.rs</code> 用于处理服务：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> crate::db::get_todos;</span><br><span class="line"><span class="keyword">use</span> actix_web::&#123;web, HttpResponse, Responder&#125;;</span><br><span class="line"><span class="keyword">use</span> deadpool_postgres::&#123;Client, Pool&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">todos</span></span>(db_pool: web::Data&lt;Pool&gt;) -&gt; <span class="keyword">impl</span> Responder &#123;</span><br><span class="line">    <span class="keyword">let</span> client: Client = db_pool</span><br><span class="line">        .get()</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .expect(<span class="string">"Error connecting to the database"</span>);</span><br><span class="line">    <span class="keyword">let</span> result = get_todos(&amp;client).<span class="keyword">await</span>;</span><br><span class="line">    <span class="keyword">match</span> result &#123;</span><br><span class="line">        <span class="literal">Ok</span>(todos) =&gt; HttpResponse::<span class="literal">Ok</span>().json(todos),</span><br><span class="line">        <span class="literal">Err</span>(_) =&gt; HttpResponse::InternalServerError().into(),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，在 <code>main.rs</code> 中创建连接池并添加路由：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mod</span> db;</span><br><span class="line"><span class="keyword">mod</span> handlers;</span><br><span class="line"><span class="keyword">mod</span> models;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> actix_web::&#123;get, web, App, HttpServer, Responder&#125;;</span><br><span class="line"><span class="keyword">use</span> deadpool_postgres;</span><br><span class="line"><span class="keyword">use</span> handlers::todos;</span><br><span class="line"><span class="keyword">use</span> std::io;</span><br><span class="line"><span class="keyword">use</span> tokio_postgres::&#123;<span class="keyword">self</span>, NoTls&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[get(<span class="meta-string">"/"</span>)]</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">hello</span></span>() -&gt; <span class="keyword">impl</span> Responder &#123;</span><br><span class="line">    <span class="built_in">format!</span>(<span class="string">"Hello world!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[actix_web::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"Starting server at http://127.0.0.1:8000"</span>);</span><br><span class="line">    <span class="comment">// 创建连接池</span></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> cfg = tokio_postgres::Config::new();</span><br><span class="line">    cfg.host(<span class="string">"localhost"</span>);</span><br><span class="line">    cfg.port(<span class="number">5432</span>);</span><br><span class="line">    cfg.user(<span class="string">"actix"</span>);</span><br><span class="line">    cfg.password(<span class="string">"actix"</span>);</span><br><span class="line">    cfg.dbname(<span class="string">"actix"</span>);</span><br><span class="line">    <span class="keyword">let</span> mgr = deadpool_postgres::Manager::new(cfg, NoTls);</span><br><span class="line">    <span class="keyword">let</span> pool = deadpool_postgres::Pool::new(mgr, <span class="number">100</span>);</span><br><span class="line">    HttpServer::new(<span class="keyword">move</span> || &#123;</span><br><span class="line">        App::new()</span><br><span class="line">            .data(pool.clone())</span><br><span class="line">            .service(hello)</span><br><span class="line">            .route(<span class="string">"/todos&#123;_:/?&#125;"</span>, web::get().to(todos))</span><br><span class="line">    &#125;)</span><br><span class="line">    .bind(<span class="string">"127.0.0.1:8000"</span>)?</span><br><span class="line">    .run()</span><br><span class="line">    .<span class="keyword">await</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行并测试：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span> cargo run</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 另一个总端，jq 用于格式化返回的 json</span><br><span class="line"><span class="meta">$</span> curl 127.0.0.1:8000/todos | jq</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    "id": 2,</span><br><span class="line">    "title": "List 2"</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    "id": 1,</span><br><span class="line">    "title": "List 1"</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2>两个改进</h2>
<ol>
<li>数据库的连接信息硬编码在代码中，在实际使用中会使用环境变量进行设置</li>
</ol>
<p>添加 <code>.env</code> 配置数据库连接信息和服务端口：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SERVER.HOST=127.0.0.1</span><br><span class="line">SERVER.PORT=8000</span><br><span class="line">PG.USER=actix</span><br><span class="line">PG.PASSWORD=actix</span><br><span class="line">PG.HOST=127.0.0.1</span><br><span class="line">PG.PORT=5432</span><br><span class="line">PG.DBNAME=actix</span><br><span class="line">PG.POOL.MAX_SIZE=30</span><br></pre></td></tr></table></figure>
<p>同时，通过环境变量获取对应配置。首先增加 <code>dotenv</code> 和 <code>config</code> 依赖：</p>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="comment"># ... 省略</span></span><br><span class="line"><span class="attr">dotenv</span> = <span class="string">"0.15.0"</span></span><br><span class="line"><span class="attr">config</span> = <span class="string">"0.10.1"</span></span><br></pre></td></tr></table></figure>
<p>然后增加 <code>config.rs</code>，增加从环境变量中获取配置并生成连接池方法 <code>from_env</code>：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> config::&#123;<span class="keyword">self</span>, ConfigError&#125;;</span><br><span class="line"><span class="keyword">use</span> serde::Deserialize;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Deserialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ServerConfig</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> host: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> port: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Deserialize, Debug)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">Config</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> server: ServerConfig,</span><br><span class="line">    <span class="keyword">pub</span> pg: deadpool_postgres::Config,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Config &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">from_env</span></span>() -&gt; <span class="built_in">Result</span>&lt;<span class="keyword">Self</span>, ConfigError&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> cfg = config::Config::new();</span><br><span class="line">        cfg.merge(config::Environment::new())?;</span><br><span class="line">        cfg.try_into()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>main.rs</code> 中使用环境变量创建连接池：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mod</span> config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> dotenv::dotenv;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[actix_web::main]</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() -&gt; io::<span class="built_in">Result</span>&lt;()&gt; &#123;</span><br><span class="line">    <span class="comment">// 环境变量</span></span><br><span class="line">    dotenv().ok();</span><br><span class="line">    <span class="comment">// 连接池</span></span><br><span class="line">    <span class="keyword">let</span> cfg = crate::config::Config::from_env().unwrap();</span><br><span class="line">    <span class="keyword">let</span> pool = cfg.pg.create_pool(NoTls).unwrap();</span><br><span class="line">    <span class="built_in">println!</span>(</span><br><span class="line">        <span class="string">"Starting server at http://&#123;&#125;:&#123;&#125;"</span>,</span><br><span class="line">        cfg.server.host, cfg.server.port</span><br><span class="line">    );</span><br><span class="line">    HttpServer::new(<span class="keyword">move</span> || &#123;</span><br><span class="line">        App::new()</span><br><span class="line">            .data(pool.clone())</span><br><span class="line">            .service(hello)</span><br><span class="line">            .route(<span class="string">"/todos&#123;_:/?&#125;"</span>, web::get().to(todos))</span><br><span class="line">    &#125;)</span><br><span class="line">    .bind(<span class="built_in">format!</span>(<span class="string">"&#123;&#125;:&#123;&#125;"</span>, cfg.server.host, cfg.server.port))?</span><br><span class="line">    .run()</span><br><span class="line">    .<span class="keyword">await</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><code>db.rs</code> 中 <code>row_to_todo</code> 函数太麻烦，使用 <code>tokio_pg_mapper</code> 做处理，简化操作：</li>
</ol>
<figure class="highlight toml"><table><tr><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="comment"># ... 省略</span></span><br><span class="line"><span class="attr">tokio-pg-mapper</span> = <span class="string">"0.1"</span></span><br><span class="line"><span class="attr">tokio-pg-mapper-derive</span> = <span class="string">"0.1"</span></span><br></pre></td></tr></table></figure>
<p>在 <code>models.rs</code> 中添加 <code>PostgresMapper</code>，</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> tokio_pg_mapper_derive::PostgresMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, PostgresMapper)]</span></span><br><span class="line"><span class="meta">#[pg_mapper(table = <span class="meta-string">"todo_list"</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TodoList</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Serialize, Deserialize, PostgresMapper)]</span></span><br><span class="line"><span class="meta">#[pg_mapper(table = <span class="meta-string">"todo_item"</span>)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">TodoItem</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> id: <span class="built_in">i32</span>,</span><br><span class="line">    <span class="keyword">pub</span> title: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">pub</span> checked: <span class="built_in">bool</span>,</span><br><span class="line">    <span class="keyword">pub</span> list_id: <span class="built_in">i32</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 <code>from_row_ref</code> 方法将记录进行转换：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">use</span> tokio_pg_mapper::FromTokioPostgresRow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">get_todos</span></span>(client: &amp;Client) -&gt; <span class="built_in">Result</span>&lt;<span class="built_in">Vec</span>&lt;TodoList&gt;, Error&gt; &#123;</span><br><span class="line">    <span class="comment">// ... 省略</span></span><br><span class="line">    <span class="keyword">let</span> todos = client</span><br><span class="line">        .query(&amp;statement, &amp;[])</span><br><span class="line">        .<span class="keyword">await</span></span><br><span class="line">        .expect(<span class="string">"Error getting todo lists"</span>)</span><br><span class="line">        .iter()</span><br><span class="line">        <span class="comment">// 修改</span></span><br><span class="line">        .map(|row| TodoList::from_row_ref(row).unwrap())</span><br><span class="line">        .collect::&lt;<span class="built_in">Vec</span>&lt;TodoList&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="literal">Ok</span>(todos)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>小结</h2>
<ol>
<li>创建 hello world 程序；</li>
<li>创建数据库连接和获取数据；</li>
<li>使用环境变量；</li>
</ol>
<h2>参考文档和项目</h2>
<ol>
<li><a href="https://www.youtube.com/watch?v=gQwA0g0NNSI" target="_blank" rel="noopener">Creating a simple TODO service with Actix</a></li>
<li><a href="actix.rs">actix-web 官方文档</a></li>
<li><a href="https://github.com/actix/examples" target="_blank" rel="noopener">actix/example</a></li>
</ol>
<blockquote>
<p>GitHub repo: <a href="https://github.com/qiwihui/blog" target="_blank" rel="noopener">qiwihui/blog</a></p>
<p>Follow me: <a href="https://github.com/qiwihui" target="_blank" rel="noopener">@qiwihui</a></p>
<p>Site: <a href="https://qiwihui.com">QIWIHUI</a></p>
</blockquote>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/技术/">#技术</a><a href="/tags/Rust/">#Rust</a></p></article></div><div class="post-copyright"><blockquote><p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/">署名-相同方式共享 | CC BY-SA 4.0 </a>许可协议。</p></blockquote></div><footer><div class="paginator"><a href="/qiwihui-blog-104/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-qiwihui-com';
var disqus_identifier = 'qiwihui-blog-105/';
var disqus_title = '用 Rust Actix-web 写一个 Todo 应用（一）';
var disqus_url = 'https://qiwihui.com/qiwihui-blog-105/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-qiwihui-com.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ["script","noscript","style","textarea","code","pre"]
    }
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46660488-3",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>